import htmlparser2 from "htmlparser2";
function injectTags(html, tags) {
  let output = html;
  if (!tags.length)
    return output;
  const pos = { "head-prepend": -1, head: -1, "body-prepend": -1, body: -1 };
  const parser = new htmlparser2.Parser({
    onopentag(tagname) {
      if (tagname === "head")
        pos["head-prepend"] = parser.endIndex + 1;
      if (tagname === "body")
        pos["body-prepend"] = parser.endIndex + 1;
    },
    onclosetag(tagname) {
      if (tagname === "head")
        pos["head"] = parser.startIndex;
      if (tagname === "body")
        pos["body"] = parser.startIndex;
    }
  });
  parser.write(html);
  parser.end();
  const lastToFirst = Object.entries(pos).sort((a, b) => b[1] - a[1]);
  lastToFirst.forEach(([name, i]) => {
    if (i === -1) {
      if (name === "head-prepend" || name === "head")
        i = 0;
      if (name === "body-prepend" || name === "body")
        i = html.length;
    }
    let selected = tags.filter(({ injectTo }) => {
      if (name === "head-prepend" && !injectTo) {
        return true;
      } else {
        return injectTo === name;
      }
    });
    if (!selected.length)
      return;
    output = output.substring(0, i) + serializeTags(selected) + html.substring(i);
  });
  return output;
}
function collectResources(html) {
  let resources = [];
  const parser = new htmlparser2.Parser({
    onopentag(tagname, attrs) {
      if (tagname === "link")
        resources.push(attrs);
    }
  });
  parser.write(html);
  parser.end();
  return resources;
}
const unaryTags = new Set(["link", "meta", "base"]);
function serializeTag({ tag, attrs, children }, indent = "") {
  if (unaryTags.has(tag)) {
    return `<${tag}${serializeAttrs(attrs)}>`;
  } else {
    return `<${tag}${serializeAttrs(attrs)}>${serializeTags(children, incrementIndent(indent))}</${tag}>`;
  }
}
function serializeTags(tags, indent = "") {
  if (typeof tags === "string") {
    return tags;
  } else if (tags && tags.length) {
    return tags.map((tag) => `${indent}${serializeTag(tag, indent)}
`).join("");
  }
  return "";
}
function serializeAttrs(attrs) {
  let res = "";
  for (const key in attrs) {
    if (typeof attrs[key] === "boolean") {
      res += attrs[key] ? ` ${key}` : ``;
    } else {
      res += ` ${key}=${JSON.stringify(attrs[key])}`;
    }
  }
  return res;
}
function incrementIndent(indent = "") {
  return `${indent}${indent[0] === "	" ? "	" : "  "}`;
}
export {
  collectResources,
  injectTags
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvc3NyL2h0bWwudHMiXSwKICAibWFwcGluZ3MiOiAiQUFFQTtBQUdPLG9CQUFvQixNQUFjLE1BQXdDO0FBQy9FLE1BQUksU0FBUztBQUNiLE1BQUksQ0FBQyxLQUFLO0FBQVEsV0FBTztBQUV6QixRQUFNLE1BQU0sRUFBRSxnQkFBZ0IsSUFBSSxNQUFNLElBQUksZ0JBQWdCLElBQUksTUFBTTtBQUd0RSxRQUFNLFNBQVMsSUFBSSxZQUFZLE9BQU87QUFBQSxJQUNwQyxVQUFVLFNBQVM7QUFDakIsVUFBSSxZQUFZO0FBQVEsWUFBSSxrQkFBa0IsT0FBTyxXQUFXO0FBQ2hFLFVBQUksWUFBWTtBQUFRLFlBQUksa0JBQWtCLE9BQU8sV0FBVztBQUFBO0FBQUEsSUFFbEUsV0FBVyxTQUFTO0FBQ2xCLFVBQUksWUFBWTtBQUFRLFlBQUksVUFBVSxPQUFPO0FBQzdDLFVBQUksWUFBWTtBQUFRLFlBQUksVUFBVSxPQUFPO0FBQUE7QUFBQTtBQUdqRCxTQUFPLE1BQU07QUFDYixTQUFPO0FBR1AsUUFBTSxjQUFjLE9BQU8sUUFBUSxLQUFLLEtBQUssQ0FBQyxHQUFHLE1BQU0sRUFBRSxLQUFLLEVBQUU7QUFDaEUsY0FBWSxRQUFRLENBQUMsQ0FBQyxNQUFNLE9BQU87QUFDakMsUUFBSSxNQUFNLElBQUk7QUFFWixVQUFJLFNBQVMsa0JBQWtCLFNBQVM7QUFBUSxZQUFJO0FBQ3BELFVBQUksU0FBUyxrQkFBa0IsU0FBUztBQUFRLFlBQUksS0FBSztBQUFBO0FBRTNELFFBQUksV0FBVyxLQUFLLE9BQU8sQ0FBQyxFQUFFLGVBQWU7QUFDM0MsVUFBSSxTQUFTLGtCQUFrQixDQUFDLFVBQVU7QUFDeEMsZUFBTztBQUFBLGFBQ0Y7QUFDTCxlQUFPLGFBQWE7QUFBQTtBQUFBO0FBR3hCLFFBQUksQ0FBQyxTQUFTO0FBQVE7QUFDdEIsYUFBUyxPQUFPLFVBQVUsR0FBRyxLQUFLLGNBQWMsWUFBWSxLQUFLLFVBQVU7QUFBQTtBQUc3RSxTQUFPO0FBQUE7QUFNRiwwQkFBMEIsTUFBMEI7QUFDekQsTUFBSSxZQUF3QjtBQUM1QixRQUFNLFNBQVMsSUFBSSxZQUFZLE9BQU87QUFBQSxJQUVwQyxVQUFVLFNBQVMsT0FBTztBQUN4QixVQUFJLFlBQVk7QUFBUSxrQkFBVSxLQUFLO0FBQUE7QUFBQTtBQUczQyxTQUFPLE1BQU07QUFDYixTQUFPO0FBQ1AsU0FBTztBQUFBO0FBa0NULE1BQU0sWUFBWSxJQUFJLElBQUksQ0FBQyxRQUFRLFFBQVE7QUFFM0Msc0JBQXNCLEVBQUUsS0FBSyxPQUFPLFlBQW9DLFNBQVMsSUFBWTtBQUMzRixNQUFJLFVBQVUsSUFBSSxNQUFNO0FBQ3RCLFdBQU8sSUFBSSxNQUFNLGVBQWU7QUFBQSxTQUMzQjtBQUNMLFdBQU8sSUFBSSxNQUFNLGVBQWUsVUFBVSxjQUFjLFVBQVUsZ0JBQWdCLGFBQWE7QUFBQTtBQUFBO0FBSW5HLHVCQUF1QixNQUEwQyxTQUFTLElBQVk7QUFDcEYsTUFBSSxPQUFPLFNBQVMsVUFBVTtBQUM1QixXQUFPO0FBQUEsYUFDRSxRQUFRLEtBQUssUUFBUTtBQUM5QixXQUFPLEtBQUssSUFBSSxDQUFDLFFBQVEsR0FBRyxTQUFTLGFBQWEsS0FBSztBQUFBLEdBQWEsS0FBSztBQUFBO0FBRTNFLFNBQU87QUFBQTtBQUdULHdCQUF3QixPQUFnRDtBQUN0RSxNQUFJLE1BQU07QUFDVixhQUFXLE9BQU8sT0FBTztBQUN2QixRQUFJLE9BQU8sTUFBTSxTQUFTLFdBQVc7QUFDbkMsYUFBTyxNQUFNLE9BQU8sSUFBSSxRQUFRO0FBQUEsV0FDM0I7QUFDTCxhQUFPLElBQUksT0FBTyxLQUFLLFVBQVUsTUFBTTtBQUFBO0FBQUE7QUFHM0MsU0FBTztBQUFBO0FBR1QseUJBQXlCLFNBQVMsSUFBSTtBQUNwQyxTQUFPLEdBQUcsU0FBUyxPQUFPLE9BQU8sTUFBTyxNQUFPO0FBQUE7IiwKICAibmFtZXMiOiBbXQp9Cg==
