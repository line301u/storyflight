var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
};
import esbuild from "esbuild";
import fs from "fs";
import { transform } from "@astrojs/compiler";
function markdown({ config }) {
  return {
    name: "@astrojs/vite-plugin-markdown",
    enforce: "pre",
    async load(id) {
      if (id.endsWith(".md")) {
        let source = await fs.promises.readFile(id, "utf8");
        let render = config.markdownOptions.render;
        let renderOpts = {};
        if (Array.isArray(render)) {
          renderOpts = render[1];
          render = render[0];
        }
        if (typeof render === "string") {
          ({ default: render } = await import(render));
        }
        let renderResult = await render(source, renderOpts);
        let { frontmatter, metadata, code: astroResult } = renderResult;
        const _a = frontmatter, { layout = "", components = "", setup = "" } = _a, content = __objRest(_a, ["layout", "components", "setup"]);
        content.astro = metadata;
        const prelude = `---
${layout ? `import Layout from '${layout}';` : ""}
${components ? `import * from '${components}';` : ""}
${setup}
const $$content = ${JSON.stringify(content)}
---`;
        const imports = `${layout ? `import Layout from '${layout}';` : ""}
${setup}`.trim();
        if (/\bLayout\b/.test(imports)) {
          astroResult = `${prelude}
<Layout content={$$content}>

${astroResult}

</Layout>`;
        } else {
          astroResult = `${prelude}
${astroResult}`;
        }
        let { code: tsResult } = await transform(astroResult, {
          projectRoot: config.projectRoot.toString(),
          site: config.buildOptions.site,
          sourcefile: id,
          sourcemap: "inline",
          internalURL: "astro/internal"
        });
        tsResult = `
export const metadata = ${JSON.stringify(metadata)};
export const frontmatter = ${JSON.stringify(content)};
${tsResult}`;
        const { code, map } = await esbuild.transform(tsResult, { loader: "ts", sourcemap: "inline", sourcefile: id });
        return {
          code,
          map: null
        };
      }
      return null;
    }
  };
}
export {
  markdown as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL3ZpdGUtcGx1Z2luLW1hcmtkb3duL2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7QUFDQTtBQUNBO0FBU2Usa0JBQWtCLEVBQUUsVUFBc0M7QUFDdkUsU0FBTztBQUFBLElBQ0wsTUFBTTtBQUFBLElBQ04sU0FBUztBQUFBLFVBQ0gsS0FBSyxJQUFJO0FBQ2IsVUFBSSxHQUFHLFNBQVMsUUFBUTtBQUN0QixZQUFJLFNBQVMsTUFBTSxHQUFHLFNBQVMsU0FBUyxJQUFJO0FBRzVDLFlBQUksU0FBUyxPQUFPLGdCQUFnQjtBQUNwQyxZQUFJLGFBQWE7QUFDakIsWUFBSSxNQUFNLFFBQVEsU0FBUztBQUN6Qix1QkFBYSxPQUFPO0FBQ3BCLG1CQUFTLE9BQU87QUFBQTtBQUVsQixZQUFJLE9BQU8sV0FBVyxVQUFVO0FBQzlCLFVBQUMsR0FBRSxTQUFTLFdBQVcsTUFBTSxPQUFPO0FBQUE7QUFFdEMsWUFBSSxlQUFlLE1BQU0sT0FBTyxRQUFRO0FBQ3hDLFlBQUksRUFBRSxhQUFhLFVBQVUsTUFBTSxnQkFBZ0I7QUFHbkQsY0FBaUUsa0JBQXpELFdBQVMsSUFBSSxhQUFhLElBQUksUUFBUSxPQUFtQixJQUFaLG9CQUFZLElBQVosQ0FBN0MsVUFBYSxjQUFpQjtBQUN0QyxnQkFBUSxRQUFRO0FBQ2hCLGNBQU0sVUFBVTtBQUFBLEVBQ3RCLFNBQVMsdUJBQXVCLGFBQWE7QUFBQSxFQUM3QyxhQUFhLGtCQUFrQixpQkFBaUI7QUFBQSxFQUNoRDtBQUFBLG9CQUNrQixLQUFLLFVBQVU7QUFBQTtBQUUzQixjQUFNLFVBQVUsR0FBRyxTQUFTLHVCQUF1QixhQUFhO0FBQUEsRUFDdEUsUUFBUTtBQUVGLFlBQUksYUFBYSxLQUFLLFVBQVU7QUFDOUIsd0JBQWMsR0FBRztBQUFBO0FBQUE7QUFBQSxFQUE0QztBQUFBO0FBQUE7QUFBQSxlQUN4RDtBQUNMLHdCQUFjLEdBQUc7QUFBQSxFQUFZO0FBQUE7QUFJL0IsWUFBSSxFQUFFLE1BQU0sYUFBYSxNQUFNLFVBQVUsYUFBYTtBQUFBLFVBQ3BELGFBQWEsT0FBTyxZQUFZO0FBQUEsVUFDaEMsTUFBTSxPQUFPLGFBQWE7QUFBQSxVQUMxQixZQUFZO0FBQUEsVUFDWixXQUFXO0FBQUEsVUFDWCxhQUFhO0FBQUE7QUFHZixtQkFBVztBQUFBLDBCQUE2QixLQUFLLFVBQVU7QUFBQSw2QkFDbEMsS0FBSyxVQUFVO0FBQUEsRUFDMUM7QUFHTSxjQUFNLEVBQUUsTUFBTSxRQUFRLE1BQU0sUUFBUSxVQUFVLFVBQVUsRUFBRSxRQUFRLE1BQU0sV0FBVyxVQUFVLFlBQVk7QUFFekcsZUFBTztBQUFBLFVBQ0w7QUFBQSxVQUNBLEtBQUs7QUFBQTtBQUFBO0FBSVQsYUFBTztBQUFBO0FBQUE7QUFBQTsiLAogICJuYW1lcyI6IFtdCn0K
